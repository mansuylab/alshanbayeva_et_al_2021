---
title: "Cauda EVs tRNAs analysis using data from both runs"
author: "Anar Alshanbayeva & Deepak Tanwar"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: tango
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    keep_md: no
    number_sections: no
    fig_width: 8
    fig_height: 8
    fig_caption: true
    df_print: paged
    code_folding: show
  fontsize: 12pt
  geometry: margin=1in
  documentclass: article
# bibliography: references.bib
link-citations: yes
---


```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Libraries required for data analysis
```{r, message=FALSE, warning=FALSE}
source("src.R")
```


# Data: read counts table from both runs

```{r, message=FALSE, warning=FALSE }
tRNAs_3 <- read.table(
  file = "./run3_excerpt_counts/exceRpt_tRNA_ReadCounts.txt",
  header = TRUE, sep = "", row.names = 1
)
tRNAs_3 <- as.data.frame(tRNAs_3)
counts_total_run3 <- tRNAs_3
tRNAs_4 <- read.table(
  file = "run4_excerpt_counts_/exceRpt_tRNA_ReadCounts.txt",
  header = TRUE, sep = "", row.names = 1
)

tRNAs_4 <- as.data.frame(tRNAs_4)

counts_total_run3 <- tRNAs_3
counts_total_run4 <- tRNAs_4

colnames(counts_total_run3) <- c(
  "MS28F1_sample11", "MS28F1_sample14",
  "MS28F1_sample2", "MS28F1_sample3",
  "MS28F1_sample4", "MS28F1_sample5",
  "MS28F1_sample6", "MS28F1_sample7",
  "MS28F1_sample8", "MS28F1_sample9"
)

colnames(counts_total_run4) <- c(
  "MS28F1_sample11_2", "MS28F1_sample14_2",
  "MS28F1_sample2_2", "MS28F1_sample3_2",
  "MS28F1_sample4_2", "MS28F1_sample5_2",
  "MS28F1_sample6_2", "MS28F1_sample7_2",
  "MS28F1_sample8_2", "MS28F1_sample9_2"
)


mlist <- list(counts_total_run3, counts_total_run4)
df <- mlist[[1]]
for (i in 2:length(mlist)) {
  df <- merge(df, mlist[[i]], by = "row.names", all = T)
  rownames(df) <- df$Row.names
  df <- df[, !(names(df) %in% "Row.names")]
  knitr::kable(head(df))
}
```



## Specifying the group & batch while filterByExprs()
```{r, message=FALSE, warning=FALSE }
counts_total <- df
d <- data.frame(
  row.names = colnames(counts_total),
  group = c(
    "G2", "G1", "G2", "G1", "G2", "G1", "G2", "G1", "G1", "G2",
    "G1", "G2", "G2", "G1", "G2", "G1", "G2", "G1", "G2", "G1"
  ),
  batch = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2)
)
counts_total[is.na(counts_total)] <- 0
dds <- calcNormFactors(DGEList(counts_total), method = "TMM")
dds$samples$group <- c(
  "G2", "G1", "G2", "G1", "G2", "G1", "G2", "G1", "G1",
  "G2", "G1", "G2", "G2", "G1", "G2", "G1", "G2", "G1", "G2", "G1"
)
dds$samples$batch <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2)
mm <- model.matrix(~ batch + group, data = d)

dds <- dds[which(filterByExpr(dds, design = mm, min.count = 10, min.prop = 0.8)), ]
en <- log1p(edgeR::cpm(dds)) # normalization by counts per million
```



## Differential Expression analysis without Surrogate Variable analysis ### 
```{r, message=FALSE, warning=FALSE }
dds <- estimateDisp(dds, mm)
fit <- glmLRT(glmFit(dds, mm), coef = "groupG2")
res_without_ruvseq <- as.data.frame(topTags(fit, Inf))
knitr::kable(head(res_without_ruvseq, n = 20))
```




## PCA plots without Surrogate Variable analysis  {.tabset .tabset-pills} 
### All samples (normalized by counts-per-million), colored by treatment group 
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(en,
  colorBy = dds$samples$group,
  add.labels = FALSE, points.size = 15
)
```

### All samples (normalized by counts-per-million), colored by library size 
Note: Even after the normalization, the libraries are separated based on lib.size, without surrogate variable analysis
Therefore, Surrogate variable analysis is necessary ### 
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(en,
  colorBy = dds$samples$lib.size,
  add.labels = FALSE, points.size = 15
)
```

### All samples (normalized by counts-per-million), colored by sequencing batch
Note: Even after the normalization, the libraries are separated based on the sequencing batch, without surrogate variable analysis 
Therefore, Surrogate variable analysis is necessary 
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(en,
  colorBy = dds$samples$batch,
  add.labels = FALSE, points.size = 15
)
```



## Differential Expression analysis with Surrogate Variable analysi, SV1 
```{r, message=FALSE, warning=FALSE }
re <- RUVSeq::RUVs(en,
  cIdx = row.names(en), k = 1,
  scIdx = RUVSeq::makeGroups(d$group), isLog = TRUE
)
d$SV1 <- re$W[, 1] # add the variable (suppose I have only one) to the colData dataframe
mm <- model.matrix(~ SV1 + batch + group, data = d)
dds <- estimateDisp(dds, mm)
fit <- glmLRT(glmFit(dds, mm), coef = "groupG2")
res_with_ruvseq1 <- as.data.frame(topTags(fit, Inf))
knitr::kable(head(res_with_ruvseq1, n = 20))
```

## PCA plots with Surrogate variable analysis, SV=1  {.tabset .tabset-pills} 

### All samples, colored by treatment group
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(re$normalizedCounts,
  colorBy = d$group,
  add.labels = FALSE, points.size = 15
)
```

### All samples, colored by library size
Note: We can observe that the samples are clustering more by groups & spread by counts. 
Libraries with high/low counts are not clustered together anymore. No effect of library size, keeping the group effect: 
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(re$normalizedCounts,
  colorBy = dds$samples$lib.size,
  add.labels = FALSE, points.size = 15
)
```

### All samples, colored by sequencing batch
Note: We can observe that the samples are corrected for sequencing batch effect:
```{r, message=FALSE, warning=FALSE }
plgINS::plPCA(re$normalizedCounts,
  colorBy = dds$samples$batch,
  add.labels = FALSE, points.size = 15
)
```


# References
```{r}
report::cite_packages(sessionInfo())
```

# SessionInfo
```{r}
devtools::session_info() %>%
  details::details()
```
